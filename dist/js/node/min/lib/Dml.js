!function(t){"use strict";var e=(0,eval)("this"),i=require("../param/Error.js").ERROR,s=require("./Querable.js").Querable,_=require("Kriteria").Kriteria||e.Kriteria,n=require("./SelectionAggregator.js").SelectionAggregator,r=require("./arraySortWithObjectElement.js").arraySortWithObjectElement,l=require("./arrayUniqueMerge.js").arrayUniqueMerge,o=require("./setFunction.js").setFunction,h=require("async"),a=require("clone"),u=function(){s.apply(this,arguments),this._check_arguments=!0,this._set_select=!1,this._set_from=!1,this._set_as=!1,this._set_insert=!1,this._set_delete=!1,this._set_update=!1,this._set_set=!1,this._set_join=!1,this._set_where=!1,this._set_group_by=!1,this._set_having=!1,this._set_order_by=!1,this._set_limit=!1,this._limit_num=0,this._set_offet=!1,this._ready_offset=!1,this._offset_num=0,this._selection=null,this._select_table="",this._table_alias="",this._select_input_query=null,this._select_input_array=null,this._insert_table="",this._insert_columns=[],this._delete_table="",this._update_table="",this._update_data="",this._joins=[],this._where=null,this._groupings=[],this._having=null,this._orderings=[],this._insert_array_values=[],this._insert_object_values=[],this._union_queries=[],this._union_all_queries=[],this._must_be_select=!1};u.prototype=Object.create(s.prototype,{constructor:{value:u,enumerable:!0,writable:!1,configurable:!0}}),u.prototype.isSelectQuery=function(){return!(this._set_insert||!this._set_select||!this._set_from)},u.prototype.isInsertQuery=function(){return!!this._set_insert},u.prototype.isDeleteQuery=function(){return!!this._set_delete},u.prototype.isUpdateQuery=function(){return!!this._set_update},u.prototype.forceSelectQuery=function(t){this._must_be_select=t},u.prototype.addUnions=function(t,e){for(var i=t.getUnions(e),s=[],_=0,n=i.length;n>_;_+=1)s[s.length]=i[_];s[s.length]=t,"union"===e?this._union_queries=s:"union_all"===e&&(this._union_all_queries=s),t.clearUnions(e)},u.prototype.getUnions=function(t){return"union"===t?this._union_queries:"union_all"===t?this._union_all_queries:[]},u.prototype.clearUnions=function(t){"union"===t?this._union_queries=[]:"union_all"===t&&(this._union_all_queries=[])},u.prototype.getTableName=function(){return this.isInsertQuery()?this._insert_table:this._select_input_query?this._table_alias||"":this.isSelectQuery()?this._table_alias||this._select_table||"":this.isDeleteQuery()?this._delete_table:this.isUpdateQuery()?this._update_table:""},u.prototype.getTableNames=function(){var t=[];this._select_table&&(t[t.length]=this._select_table),this._table_alias&&(t[t.length]=this._table_alias);for(var e=0,i=this._joins.length;i>e;e+=1){var s=this._joins[e][3];s&&(t[t.length]=s)}return t},u.prototype.select=function(t){if(this._set_select||this._set_values||this._set_delete||this._set_update)throw i.invalid_description("select");if(this._check_arguments&&0!==arguments.length&&1!==arguments.length&&"function"!=typeof t&&void 0!==t)throw i.invalid_argument("select");return this._set_select=!0,this._selection=t,this},u.prototype.from=function(){if(!this._set_select||this._set_from||this._set_join||this._set_where||this._set_group_by||this._set_having||this._set_order_by||this._set_limit)throw i.invalid_description("from");if(this._check_arguments&&0===arguments.length)throw i.invalid_argument("from");this._set_from=!0;for(var t=0,e=arguments.length;e>t;t+=1){var s=arguments[t];if("string"==typeof s||s instanceof String)0===t?this._select_table=s:this.join(s);else if(s instanceof u){if(!s.isSelectQuery())throw i.invalid_argument("from");0===t?this._select_input_query=s:this.join(s)}else if(Array.isArray(s))0===t?(this._select_input_array=s,this._table_alias="left"):this.join(s);else for(var _ in s)0===t?(this._select_table=_,this.as(s[_])):this.join(_).as(s[_])}return this},u.prototype.as=function(t){if(!this._set_select||!this._set_from&&!this._set_join||this._set_as||this._set_where||this._set_group_by||this._set_having||this._set_order_by||this._set_limit)throw i.invalid_description("as");if(this._check_arguments&&!("string"==typeof t||t instanceof String&&""!==t))throw i.invalid_argument("as");return this._set_as=!0,this._set_join?this._joins[this._joins.length-1]&&(this._joins[this._joins.length-1][3]=t):this._table_alias=t,this},u.prototype.insert_into=u.prototype.insertInto=function(t,e){if(this._must_be_select||this._set_select||this._set_insert||this._set_delete||this._set_update)throw i.invalid_description("insert_into");if(this._check_arguments&&1!==arguments.length&&2!==arguments.length)throw i.invalid_argument("insert_into");return this._set_insert=!0,this._insert_table=t,Array.isArray(e)&&e.length>0&&(this._insert_columns=e),this},u.prototype.delete_from=u.prototype.deleteFrom=function(t){if(this._must_be_select||this._set_select||this._set_insert||this._set_delete||this._set_update)throw i.invalid_description("delete_from");if(this._check_arguments&&1!==arguments.length)throw i.invalid_argument("delete_from");return this._set_delete=!0,this._delete_table=t,this},u.prototype.update=function(t){if(this._must_be_select||this._set_select||this._set_insert||this._set_delete||this._set_update)throw i.invalid_description("update");if(this._check_arguments&&1!==arguments.length)throw i.invalid_argument("update");return this._set_update=!0,this._update_table=t,this},u.prototype.set=function(t){if(!this._set_update)throw i.invalid_argument("set");if(this._check_arguments&&1!==arguments.length)throw i.invalid_argument("set");return this._set_set=!0,this._update_data=t,this},u.prototype.join=function(t,e,s){if(!this._set_select||!this._set_from||this._set_where||this._set_group_by||this._set_having||this._set_order_by||this._set_limit)throw i.invalid_description("join");if(this._check_arguments&&(0===arguments.length||arguments.length>3))throw i.invalid_argument("join");var n=null,r=s||"inner";arguments.length>=2&&("function"==typeof e?(n=new _,e(n)):e instanceof _&&(n=e)),this._set_join=!0,this._set_as=!1;var l=this._joins.length;if(t instanceof u)this._joins[l]=[t,n,null,"",r];else if("string"==typeof t||t instanceof String)this._joins[l]=[new u(this._sli2_object).select().from(t),n,null,t,r];else if(Array.isArray(t))this._joins[l]=[null,n,t,"right_"+(l+1),r];else if(this._check_arguments)throw i.invalid_argument("join");return this},u.prototype.inner_join=u.prototype.innerJoin=function(t,e){return this.join(t,e,"inner")},u.prototype.left_join=u.prototype.leftJoin=function(t,e){return this.join(t,e,"left")},u.prototype.right_join=u.prototype.rightJoin=function(t,e){return this.join(t,e,"right")},u.prototype.where=function(t){if(!(this._set_select&&this._set_from||this._set_delete||this._set_update&&this._set_set)||this._set_where||this._set_group_by||this._set_having||this._set_order_by||this._set_limit)throw i.invalid_description("where");if(this._check_arguments&&1!==arguments.length)throw i.invalid_argument("where");var e=null;return"function"==typeof t?(e=new _,t(e)):e=t,this._set_where=!0,this._where=e,this},u.prototype.group_by=u.prototype.groupBy=function(){if(!this._set_select||!this._set_from||this._set_group_by||this._set_order_by||this._set_having||this._set_limit)throw i.invalid_description("group_by");if(this._check_arguments&&(0===arguments.length||Array.isArray(arguments[0])&&0===arguments[0].length))throw i.invalid_argument("group_by");var t=0,e=0;if(this._set_group_by=!0,this._groupings=[],Array.isArray(arguments[0]))for(t=0,e=arguments[0].length;e>t;t+=1)this._groupings[this._groupings.length]=arguments[0][t];else for(t=0,e=arguments.length;e>t;t+=1)this._groupings[this._groupings.length]=arguments[t];return this},u.prototype.having=function(t){if(!(this._set_select&&this._set_from&&this._set_group_by)||this._set_order_by||this._set_having||this._set_limit)throw i.invalid_description("having");if(this._check_arguments&&1!==arguments.length)throw i.invalid_argument("having");var e=null;return"function"==typeof t?(e=new _,t(e)):e=t,this._set_having=!0,this._having=e,this},u.prototype.union=function(){if(!this.isSelectQuery()||this._set_order_by||this._set_limit||this._union_all_queries.length>0)throw i.invalid_description("union");var t=new u(this._sli2_object);return t.forceSelectQuery(!0),t.addUnions(this,"union"),t},u.prototype.union_all=u.prototype.unionAll=function(){if(!this.isSelectQuery()||this._set_order_by||this._set_limit||this._union_queries.length>0)throw i.invalid_description("union_all");var t=new u(this._sli2_object);return t.forceSelectQuery(!0),t.addUnions(this,"union_all"),t},u.prototype.order_by=u.prototype.orderBy=function(){if(!this._set_select||!this._set_from||this._set_order_by||this._set_limit)throw i.invalid_description("order_by");if(this._check_arguments&&(0===arguments.length||Array.isArray(arguments[0])&&0===arguments[0].length))throw i.invalid_argument("order_by");var t=0,e=0;if(this._set_order_by=!0,this._orderings=[],Array.isArray(arguments[0]))for(t=0,e=arguments[0].length;e>t;t+=1)this._orderings[this._orderings.length]=arguments[0][t];else for(t=0,e=arguments.length;e>t;t+=1)this._orderings[this._orderings.length]=arguments[t];return this},u.prototype.limit=function(t,e){if(!this._set_select||!this._set_from||this._set_limit)throw i.invalid_description("limit");if(this._check_arguments&&0===arguments.length||arguments.length>2||arguments.length>0&&(Number.isNaN(+arguments[0])||arguments[0]<0)||arguments.length>1&&(Number.isNaN(+arguments[1])||arguments[1]<0))throw i.invalid_argument("limit");return this._set_limit=!0,1===arguments.length?this._limit_num=0|t:2===arguments.length&&(this._offset_num=0|t,this._limit_num=0|e),this},u.prototype.offset=function(t){if(!this._set_limit||this._set_offet)throw i.invalid_description("offset");if(this._check_arguments&&1===arguments.length&&(Number.isNaN(+arguments[0])||arguments[0]<0))throw i.invalid_argument("offset");return this._set_offet=!0,this._offset_num=t,this},u.prototype.values=function(){if(!this._set_insert||this._set_values)throw i.invalid_description("values");if(this._check_arguments&&(0===arguments.length||Array.isArray(arguments[0])&&0===arguments[0].length))throw i.invalid_argument("values");var t=!1,e=0,s=0;for(this._set_values=!0,this._insert_array_values=[],this._insert_object_values=[],e=0,s=arguments.length;s>e;e+=1){var _=arguments[e];if(Array.isArray(_))this._insert_array_values[this._insert_array_values.length]=_;else{if(_.constructor!==Object){t=!0;break}this._insert_object_values[this._insert_object_values.length]=_}}if(t)for(this._insert_array_values=[[]],this._insert_object_values=[],e=0,s=arguments.length;s>e;e+=1)this._insert_array_values[0][e]=arguments[e];return this},u.prototype._isRunnable=function(){return this._set_select&&this._set_from||this._set_insert||this._set_delete||this._set_update&&this._set_set},u.prototype.exec=function(t,e,s){if(!this._isRunnable())throw i.invalid_description("exec");var u=this,c=this._sli2_object,f="function"==typeof e?e:function(){},g="function"==typeof s?s:function(){},p=[],d=0,y=0,b=0,m=0,v=0,w=0;if(void 0===c||null===c)throw i.querable_is_not_initialized;var j=function(){f()},A=function(t){return function(e){g(i.dml_exec_error(t+" / "+e.message))}},q=function(){},Q="function"==typeof t?t:j;if(u.isInsertQuery()){if(q=A("insert_into"),!c.tables[u._insert_table])return void q(i.table_not_exist(u._insert_table));if(u._insert_array_values.length>0||u._insert_object_values.length>0){var k=[];if(u._insert_array_values.length>0)if(u._insert_columns.length>0)for(d=0,y=u._insert_array_values.length;y>d;d+=1)for(k[d]={},b=0,m=u._insert_columns.length;m>b;b+=1)k[d][u._insert_columns[b]]=u._insert_array_values[d][b];else q(new Error("unsupported command."));if(u._insert_object_values.length>0)for(d=0,y=u._insert_object_values.length;y>d;d+=1)k[k.length]=u._insert_object_values[d];c.tables[u._insert_table].add(k,function(t){Q(t,j,q)},q)}else q(u._set_select?new Error("unsupported command."):i.invalid_description("insert_into"))}else if(u.isDeleteQuery()){if(q=A("delete_from"),!c.tables[u._delete_table])return void q(i.table_not_exist(u._delete_table));u._where?c.tables[u._delete_table].removeForQuery(u._where,function(t){Q(t,j,q)},q):c.tables[u._delete_table].removeAll(function(t){Q(t,j,q)},q)}else if(u.isUpdateQuery()){if(!c.tables[u._update_table])return void q(i.table_not_exist(u._update_table));u._where?c.tables[u._update_table].updateForQuery(u._where,u._update_data,function(t){Q(t,j,q)},q):c.tables[u._update_table].updateAll(u._update_data,function(t){Q(t,j,q)},q)}else if(u.isSelectQuery()){q=A("select");var S=[],N={},W=null,U=null,x=null,J="";if(this._where)if(S=this.getTableNames(),N=this._where.splitByKeyPrefixes(S)){N[this._select_table]&&N[this._table_alias]&&q(i.kriteria_prefix_conflict(this._select_table,this._table_alias));var O=new _,R=0;if(N[u._select_table]||N[u._table_alias]){W=N[u._select_table]||N[u._table_alias];for(J in N)N[J]&&J!==u._select_table&&J!==u._table_alias&&("else"===J?x=N[J]:(R+=1,O=O.merge(N[J])));R>0&&(U=O)}else{W=N["else"];for(J in N)N[J]&&("else"===J?x=N[J]:(R+=1,O=O.merge(N[J])));R>0&&(U=O)}}else x=this._where;new Promise(function(t,e){if(u._select_table){if(!c.tables[u._select_table])return void q(i.table_not_exist(u._select_table));N[u._select_table]?c.tables[u._select_table].selectForQuery(W,N[u._select_table]?u._select_table:u._tablea_alias,u._table_alias||(u._joins.length>0?u._select_table:""),function(e){j(),t(e)},e):c.tables[u._select_table].selectAll(u._joins.length>0?u._table_alias||u._select_table:u._table_alias,function(e){j(),t(e)},e)}else if(u._select_input_query)u._select_input_query.run(function(e,i){var s=[];if(u._table_alias)for(d=0,y=e.length;y>d;d+=1)s[d]={},s[d][u._table_alias]=e[d];else s=e;j(),t(s),i()});else if(u._select_input_array){var s=[];if(W){var _=null;if(0===u._joins.length?N[u._table_alias]&&N["else"]?_=o.setWithNoJoinAndAliasWhere:N[u._table_alias]&&!N["else"]?_=o.setWithNoJoinAndAliasWhere:!N[u._table_alias]&&N["else"]&&(_=o.setWithNoJoinAndNoAliasWhere):N[u._table_alias]&&N["else"]?_=o.setWithHasJoinAndAliasWhere:N[u._table_alias]&&!N["else"]?_=o.setWithHasJoinAndAliasWhere:!N[u._table_alias]&&N["else"]&&(_=o.setWithHasJoinAndNoAliasWhere),null===_)s=u._select_input_array;else for(d=0,y=u._select_input_array.length;y>d;d+=1)_(u._select_input_array[d],s,W,u._table_alias)}else if(0===u._joins.length)s=u._select_input_array;else for(d=0,y=u._select_input_array.length;y>d;d+=1){var n={};n[u._table_alias]=u._select_input_array[d],s[s.length]=n}j(),t(s)}else e(i.invalid_description("select"))}).then(function(t){return new Promise(function(e,s){var _=[];if(0===u._joins.length)e(t);else{var n=t,r=0;h.eachSeries(u._joins,function(t,e){var l=t[0],o=t[1],h=t[2],u=t[3],c=t[4],f={},g=0,p=[],j=[],A="",q="",Q=[];_=[],r+=1,new Promise(function(t,e){l&&l.isSelectQuery?l.run(function(e,i){i(),t([e,u||""])}):h?t([h,u]):e(i.reqire_select_query)}).then(function(t){var i=t[0],s=t[1];if("inner"===c){for(d=0,y=n.length;y>d;d+=1)for(b=0,m=i.length;m>b;b+=1){if(f=a(n[d]),s)f[s]=i[b];else for(Q=Object.keys(i[1]),v=0,w=Q.length;w>v;v+=1)J=Q[v],f[J]=i[b][J];o&&!o.match(f)||(_[_.length]=a(f))}n=_}else if("left"===c||"right"===c){for("left"===c?(p=n,j=i,A="",q=s):(p=i,j=n,A=s,q=""),d=0,y=p.length;y>d;d+=1){for(g=0,b=0,m=j.length;m>b;b+=1){if(f={},A?f[A]=a(p[d]):f=a(p[d]),q)f[q]=a(j[b]);else for(Q=Object.keys(j[b]),v=0,w=Q.length;w>v;v+=1)J=Q[v],f[J]=j[b][J];o&&!o.match(f)||(_[_.length]=a(f),g+=1)}0===g&&(f={},A?f[A]=p[d]:f=p[d],_[_.length]=a(f))}n=_,p=[],j=[]}e()})["catch"](function(t){s(t)})},function(){n=[],e(_)})}}).then(function(t){var e=[];if(U){for(d=0,y=t.length;y>d;d+=1)U.match(t[d])&&(e[e.length]=t[d]);return e}return t}).then(function(t){var e=n.createAggregationOperator(u._groupings);if(u._selection){for(d=0,y=t.length;y>d;d+=1)u._selection(e,t[d]),e.aggregate();return e.getResult()}if(u._groupings.length>0){var i=function(t,e){for(J in e)t(e[J]).as(J)};for(d=0,y=t.length;y>d;d+=1)i(e,t[d]),e.aggregate();return e.getResult()}return t}).then(function(t){var e=[];if(x){for(d=0,y=t.length;y>d;d+=1)x.match(t[d])&&(e[e.length]=t[d]);return e}return t}).then(function(t){var e=[];if(u._having)for(d=0,y=t.length;y>d;d+=1)u._having.match(t[d])&&(e[e.length]=t[d]);else e=t;return e}).then(function(t){if(u._orderings.length>0&&(t=r(t,u._orderings)),u._limit_num>0){var e=[];for(d=0+u._offset_num,y=u._limit_num+u._offset_num;y>d&&!(y>t.length);d+=1)e[e.length]=t[d];t=e,e=[]}return t}).then(function(t){return new Promise(function(e,i){u._union_queries.length>0?h.eachSeries(u._union_queries,function(t,e){t.run(function(t){p=l(p,t),e()})["catch"](function(t){i(t)})},function(){p=l(p,t),e(p)}):u._union_all_queries.length>0?h.eachSeries(u._union_all_queries,function(t,e){t.run(function(t){for(d=0,y=t.length;y>d;d+=1)p[p.length]=t[d];e()})["catch"](function(t){i(t)})},function(){for(d=0,y=t.length;y>d;d+=1)p[p.length]=t[d];e(p)}):e(t)})}).then(function(t){Q(t,function(){},A("select - run process"))})["catch"](A("select - promise"))})["catch"](function(t){q(t)})}},t.Dml=u}(this);