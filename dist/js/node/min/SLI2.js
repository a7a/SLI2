!function(e,t){"use strict";var n=require("./lib/idbInit.js").idbInit,o=require("./lib/Dml.js").Dml,i=require("./lib/Ddl.js").Ddl,r=require("./lib/DatabaseDefinition.js").DatabaseDefinition,s=require("./lib/Table.js").Table,a=require("./lib/Tasker.js").Tasker,_=require("./param/Error.js").ERROR,d=function(e,t){this._name=e,this.db=null,this.transaction=null,this._version=0,this._upgrade_enable=!0,this._mode="",this._use_idb=!1,this._opened=!1,this._closed=!1,this._upgrading=!1,this._transacting=!1,this.tables={},this._idb_objects=null,this._tasker=new a,this._tasker.auto_run=!0,t?t.mode&&this.setMode(t.mode):this.useIndexedDB()};d.USE_IDB="idb",d.NO_IDB="no_idb",d.READ_WRITE="readwrite",d.READ_ONLY="readonly",d.DEFAULT_UPGRADING_HANDLER="sli2_upgrade",d.DEFAULT_TRANSACTION_HANDLER="sli2_transaction",d.prototype.useIndexedDB=function(){if(this._idb_objects=n(),null===this._idb_objects)throw _.idb_objects_not_exists;this._mode===d.NO_IDB&&(this._opened=!1),this._mode=d.USE_IDB,this._use_idb=!0},d.prototype.setMode=function(e){e===d.USE_IDB?this.useIndexedDB():e===d.NO_IDB&&(this._mode=d.NO_IDB,this._idb_objects=null,this._use_idb=!1,this._opened=!0,this._closed=!1)},d.createDatabaseDefinition=function(){return new r},d.prototype.deleteDatabase=function(e,t){var n=this;return new Promise(function(o,i){if(n._mode===d.NO_IDB)return void i(_.mode_is_no_idb);if(!n._use_idb)return void i(_.idb_objects_not_used);var r=n._idb_objects.indexedDB.deleteDatabase(e||n._name);r.onsuccess=function(){o()},r.onerror=function(){i()},r.onblocked="function"==typeof t?t:function(){console.log("deletedatabase blocking")}})},d.prototype._initTables=function(){for(var e=this.db,t=0,n=e.objectStoreNames.length;n>t;t+=1){var o=e.objectStoreNames[t],i=new s(o,null,this);this.tables[o]=i}},d.prototype._openTables=function(e,t,n){var o=n||this.tables;for(var i in o)this.tables[i].open(e,t)},d.prototype._closeTables=function(e,t){var n=t||this.tables;for(var o in n)this.tables[o].close(e)},d.prototype._destroyTables=function(){for(var e in this.tables)this.tables[e].destroy()},d.prototype._initInOpen=function(e){this.db=e,0===this._version&&(this._version=e.version),this._opened=!0,this._closed=!1},d.prototype.isUpgrading=function(){return this._upgrading},d.prototype.isTransacting=function(){return this._transacting},d.prototype.open=function(e){var t=this,n=null,o=[],i=[],s={},a=0,u=0;return new Promise(function(c,l){var p=null;return t._mode===d.NO_IDB?void l(_.mode_is_no_idb):t._opened?void l(_.already_open):t._use_idb?void(e instanceof r?new Promise(function(r,d){return o=e.getVersionMapStartWithVersion(1),t.db&&t.db.close(),o?(i=o.seq,s=o.map,n=t._idb_objects.indexedDB.open(t._name),n.onupgradeneeded=function(e){for(t._initInOpen(e.target.result),t.transaction=this.transaction,t._upgrading=!0,t._initTables(),t._openTables(this.transaction,"version_change"),t._tasker.auto_run=!1,a=0,u=i.length;!p&&u>a;a+=1){var n=s[i[a]];"function"==typeof n?n(t):p=_.no_definition(i[a])}t._tasker.addTask(null,function(e){t._version=i[a-1],t.transaction=null,t._upgrading=!1,t.db=null,t._tasker.auto_run=!0,e()}).runQueue()},n.onsuccess=function(e){t._initInOpen(e.target.result),p?d(p):(t._destroyTables(),t._initTables(),r())},n.onerror=function(e){d(e.target.error)},void 0):void d(_.no_version_map(1))}).then(function(){return new Promise(function(r,d){if(t.db.close(),e.isLatestVersion(t._version))n=t._idb_objects.indexedDB.open(t._name,t._version),n.onsuccess=function(e){t._initInOpen(e.target.result),r()},n.onerror=function(e){d(e.target.error)};else{o=e.getVersionMapStartWithVersion(t._version+1);var c=e.getLatestVersionForVersion(t._version);o?(i=o.seq,s=o.map,n=t._idb_objects.indexedDB.open(t._name,c),n.onupgradeneeded=function(e){for(t._initInOpen(e.target.result),t.transaction=this.transaction,t._upgrading=!0,t._initTables(),t._openTables(this.transaction,"version_change"),t._tasker.auto_run=!1,a=0,u=i.length;!p&&u>a;a+=1){var n=s[i[a]];"function"==typeof n?n(t):p=_.no_definition(i[a])}t._tasker.addTask(null,function(e){t._version=i[a-1],t.transaction=null,t._upgrading=!1,t.db=null,t._tasker.auto_run=!0,e()}).runQueue()},n.onsuccess=function(e){t._initInOpen(e.target.result),p?d(p):(t._destroyTables(),t._initTables(),r())},n.onerror=function(e){d(e.target.error)}):p=_.no_version_map(t._version)}})}).then(function(){t._upgrade_enable=!1,c(t.db)})["catch"](function(e){l(e)}):(t._upgrade_enable=!0,t.db&&t.db.close(),n=t._idb_objects.indexedDB.open(t._name),n.onsuccess=function(e){t._initInOpen(e.target.result),t._initTables(),c(t.db)},n.onerror=function(e){l(e.target.error)})):void l(_.idb_objects_not_used)})},d.prototype.close=function(){var e=this;return new Promise(function(t){e._tasker.addTask(null,function(n){e.db&&e.db.close(),e._name=null,e.db=null,e.transaction=null,e._version=0,e._upgrade_enable=!0,e._mode=null,e._upgrading=!1,e._transacting=!1,e._opened=!1,e._closed=!0,e._tasker.terminate(),e._destroyTables(),e.tables={},t(),n()})})},d.prototype.destroy=function(){var e=this;return this.close().then(function(){e._use_idb=!1,e._idb_objects=null,e.tables=null})},d.prototype.getCurrentVersion=function(){return this._version},d.prototype.getNewVersion=function(){if(this._mode===d.NO_IDB)throw _.mode_is_no_idb;if(!this._opened)throw _.not_open;if(this._closed)throw _.closed;return this._version=this._version+1,this._version},d.prototype.begin_transaction=d.prototype.beginTransaction=function(e,t,n){var o=this;return new Promise(function(i,r){var s=[],a={},u=0,c=0,l=function(){o.transaction=null,o._transacting=!1;try{o._closeTables("sli2_transaction",a)}catch(e){r(e)}};if(Array.isArray(e)?s=e:s[0]=e,o._mode===d.NO_IDB)r(_.mode_is_no_idb);else if(o._opened){if(o._closed)r(_.closed);else if(!o._transacting){for(o._transacting=!0,u=0,c=s.length;c>u;u+=1){var p=s[u];if(!o.tables[p])return void r(_.table_not_exist(p));a[p]=o.tables[p]}var h=o.db.transaction(s,t);h.oncomplete=function(){l(),i()},h.onabort=function(){o._tasker.terminate(),l(),r(_.transaction_abort("transaction"))},o.transaction=h;try{o._openTables(h,"sli2_transaction",a)}catch(b){r(b)}}}else r(_.not_open);if("function"==typeof n)try{o._tasker.auto_run=!1,n(),o._tasker.addTask(null,function(){o._tasker.auto_run=!0}).runQueue()}catch(f){o.rollback(),l(),r(f)}})},d.prototype.upgrade=function(e,t){var n=this;return new Promise(function(o,i){var r="function"==typeof e?e:function(){},s="function"==typeof t?t:function(){};if(n._mode===d.NO_IDB)i(_.mode_is_no_idb);else if(n._upgrade_enable)if(n._opened)if(n._closed)i(_.closed);else if(n._upgrading)try{r(n.db,n.transaction),s(),o()}catch(a){i(a)}else{n._upgrading=!0,n.db.close();var u=n._idb_objects.indexedDB.open(n._name,n.getNewVersion());u.onupgradeneeded=function(e){var t=e.target.result,o=this.transaction;o.onabort=function(){i(_.transaction_abort("upgrade"))},n.db=t,n.transaction=o,n._openTables(o,"sli2_upgrade");try{n._tasker.auto_run=!1,r(t,o),n._tasker.addTask(null,function(){n._tasker.auto_run=!0}).runQueue()}catch(e){i(e)}},u.onsuccess=function(e){n._upgrading=!1,n._upgrading===!1&&(n.db=e.target.result),n.transaction=null,n._closeTables("sli2_upgrade"),s(),o()},u.onerror=function(e){i(_.upgrade_error(e.target.error))}}else i(_.not_open);else i(_.update_unable)})},d.prototype.addTask=function(e,t){if(this._closed)throw _.closed;return this._tasker.addTask(e,t)},d.prototype.runQueue=function(){if(this._closed)throw _.closed;return this._tasker.runQueue()},d.prototype.create_table=d.prototype.createTable=function(e,t){var n=t?t:{autoIncrement:!0};if(this._mode===d.NO_IDB)throw _.mode_is_no_idb;if(!this._upgrade_enable)throw _.update_unable;if(!this._opened)throw _.not_open;if(this._closed)throw _.closed;var o=new i(this);return o.createTable(e,n)},d.prototype.drop_table=d.prototype.dropTable=function(e){if(this._mode===d.NO_IDB)throw _.mode_is_no_idb;if(!this._upgrade_enable)throw _.update_unable;if(!this._opened)throw _.not_open;if(this._closed)throw _.closed;var t=new i(this);return t.dropTable(e)},d.prototype.create_index=d.prototype.createIndex=function(e,t,n){if(this._mode===d.NO_IDB)throw _.mode_is_no_idb;if(!this._upgrade_enable)throw _.update_unable;if(!this._opened)throw _.not_open;if(this._closed)throw _.closed;if(!n)throw _.no_option("createIndex");var o=new i(this);return o.createIndex(e,t,n)},d.prototype.drop_index=d.prototype.dropIndex=function(e,t){if(this._mode===d.NO_IDB)throw _.mode_is_no_idb;if(!this._opened)throw _.not_open;if(!this._upgrade_enable)throw _.update_unable;if(this._closed)throw _.closed;var n=new i(this);return n.dropIndex(e,t)},d.prototype.select=function(e){if(!this._opened)throw _.not_open;if(this._closed)throw _.closed;var t=new o(this);return t.select(e)},d.prototype.insert_into=d.prototype.insertInto=function(e,t){if(this._mode===d.NO_IDB)throw _.mode_is_no_idb;if(!this._opened)throw _.not_open;if(this._closed)throw _.closed;var n=new o(this);return n.insert_into(e,t)},d.prototype.delete_from=d.prototype.deleteFrom=function(e){if(this._mode===d.NO_IDB)throw _.mode_is_no_idb;if(!this._opened)throw _.not_open;if(this._closed)throw _.closed;var t=new o(this);return t.delete_from(e)},d.prototype.update=function(e){if(this._mode===d.NO_IDB)throw _.mode_is_no_idb;if(!this._opened)throw _.not_open;if(this._closed)throw _.closed;var t=new o(this);return t.update(e)},d.prototype.rollback=function(){if(this._mode===d.NO_IDB)throw _.mode_is_no_idb;if(!this._opened)throw _.not_open;if(this._closed)throw _.closed;if(!this.transaction)throw _.no_transaction;this.transaction.abort(),this._tasker.terminate(),this._tasker.auto_run=!0},e.SLI2=d,t.SLI2=d}(this,(0,eval)("this").window||this);